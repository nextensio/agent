# Simple Testing without Xcode and packetTunnel extensions and stuff

So on mac if we test using packetTunnel extension, that will suck in all traffic,
which probably we dont want to do if we just want to run real quick tests. The
method below allows us to test with just cargo/rust and no Xcode etc..

cargo build here will generate an apple_test binary under target/. That binary
needs to be run as sudo - ie "sudo target/debug/apple_test" for example. What 
that does is it will create a utun interface, most of the times a utun0, but if
there is already another utun0, it might create a utun1 for example. You can do
an ifconfig -a and find the utun which has an ip address of 169.254.2.1, that is
the utun of our interest, lets say that is utun0 for sake of discussion.

Now lets say we want to test https access to say google.com, these are the steps 
I do.

1. In the code, change the below - basically we are changing the destination from
"1.1.1.1" to "google.com" :-)  Now compile the code (cargo build in platforms/apple_test)
and run the binary (sudo ../../target/debug/apple_test)

```
diff --git a/rust/agent/src/lib.rs b/rust/agent/src/lib.rs
index 628528b..2bc724d 100644
--- a/rust/agent/src/lib.rs
+++ b/rust/agent/src/lib.rs
@@ -318,7 +318,8 @@ fn flow_new(
     if direct {
         tx_socket = *next_tun_idx;
         let mut tun = NetConn::new_client(
-            key.dip.to_string(),
+            //key.dip.to_string(),
+            "google.com".to_string(),
             key.dport as usize,
             key.proto,
             true,
```

2. Add a route for say 1.1.1.1 like this - "sudo route add -host 1.1.1.1 -interface utun0"

3. Now do "curl -k https://1.1.1.1" - and you can see google  complaining about page moved, http 301 etc..

Now why do we have to do this 1.1.1.1 and changing the code to google.com business ? Because if we add a 
route for google.com IP address which is say 142.250.80.14 via utun0 in step2, and then do a 
curl -k https://142.250.80.14 without any of the code changes in step1, then the socket that the 
agent originates to 142.250.80.14 in flow_new() will get re-routed back via utun0 - so that will be a loop!

NOTE TO RUDY: Rudy, one symptom of a "loop" above is that you will see that a single curl request suddenly
generates like a dozen tcp flows ! I was seeing that initially when I started testing with this binary where
a single url generates a dozen or more flows and then each of them gets into a SYN retransmit - almost exactly
what you saw in your wireshark dump. I pulled my hair out for a while and then I figured out that whatever
gets sent out in flow_new() socket connection is coming back to utun0, so the agent thinks thats a new flow,
and then it creates one more socket for that flow which again gets looped into the agent which creates one
more flow etc.. - so none of the SYN gets a response, so the OS keeps retransmitting SYN. So if you continue
to see this behaviour, please double confirm that you have proper settings for macos to ignore the packets
generated by the agent itself and not loop it back